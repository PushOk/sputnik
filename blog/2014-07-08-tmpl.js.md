# Tmpl.js

Когда нам нужно обработать строковые шаблоны путём замены, на помощь приходит [Tmpl.js](https://github.com/GC92/tmpl)!

О нём я расскажу ниже, но для начала немного истории о том, как мы делали замену раньше и к чему я пришёл,
чтобы сделать шаблонизацию более удобней.

## Replace replace replace...

Обычно, когда нам приходилось делать замену, мы использовали `String.replace()` для замены в строках ключей,
обёрнутых в двойные фигурные скобки `{{key}}`.
```javascript
'Сегодня {{weather}} погода.'.replace(/{{weather}}/, 'тёплая');
// Вернёт "Сегодня тёплая погода."
```

А что, если нам нужно заменить не одно значение, а несколько?
```javascript
var myTmpl = 'Сегодня {{weather}} погода - самое время пойти на {{place}}!';
myTmpl.replace(/{{weather}}/, 'тёплая')
      .replace(/{{place}}/, 'пляж');
// Вернёт "Сегодня тёплая погода - самое время пойти на пляж!"
```

Хорошо, мы добавляем метод `.replace()` каждый раз, когда нужно добавить ещё одно значение.
В этом примере у нас всего два значения, но в один прекрасный момент у нас этих данных появится на десятки строк,
что существенно затруднит как читаемость кода, так и дальнейшую поддержку.

А если мне данные приходят из `json`?
Перебирать все данные, делать велосипеды и наступать на грабли?
А что на счёт повторного использования?
Мысль наталкивает только на одно - нужно сделать простой скрипт, который поможет решить все эти проблемы.

## Эксперименты

Я начал с того, чтобы узнать, какие аргументы передает функции метод `replace`.
```javascript
'{{text}}'.replace(/{{(\w*)}}/g, function(match, key, position) {
    console.log(match, key, position);
});
```

* `match` - найденная подстрока.
* `key` - ключ или совпадение в строке, находящееся в круглых скобках в шаблоне `RegExp`.
* `position` - позиция совпадения в строке.

Нам интересен только `key`.
```javascript
'{{text}}'.replace(/{{(\w*)}}/g, function(match, key, position) {
    return ({text: 'CSSSR'})[key];
});
// Вернёт "CSSSR"
```

Отлично, теперь можно добавлять свои данные в виде ассоциативного массива или объекта,
и в зависимости от найденного ключа заменит на наше значение. Едем дальше.

Сначала у меня была мысль, что можно обернуть это в функцию и использовать везде,
где необходимо, но потом передумал и решил оформить в виде метода `String.tmpl()`.
```javascript
String.prototype.tmpl = function (data) {
        return this.replace(/{{(\w*)}}/g, function(match, key, position) {
        return data[key];
    });
};

'{{text}}'.tmpl({text: 'CSSSR'});
// Вернёт "CSSSR"
```

Круто! Это уже в сто раз лучше, чем мы страдали раньше.

Недолго поразмыслив, я задумался на тем, чтобы сделать защиту от дурака на случай,
если разработчик до или после ключа между двойными фигурными скобками случайно поставит пробел.

Используем метод `trim()` для удаление лишних пробелов в начале и конце строки.
```javascript
String.prototype.tmpl = function (data) {
    return this.replace(/{{(\w*)}}/g, function(match, key, position) {
        return data[key.trim()];
    });
};
```

Как говорится, ещё +10 к скиллу.

Но тут я вспомнил, что поддержки этого метода нет в IE8, если необходимо его поддерживать.

Ничего, добавим поддержку.
```javascript
// Совместимость с вашим любимым IE8 :*
if (!String.prototype.trim) {
    String.prototype.trim = function () {
        return this.replace(/^\s+|\s+$/gm, '');
    };
}
```

В зависимости от поддержки мы можем использовать ту или иную версию.

Дорабатываем наш скрипт и добавляем баннер.
```javascript
/*! Tmpl.js v0.1.0 | GC92 | MIT | https://github.com/GC92/tmpl */
(function () {
    String.prototype.tmpl = function (data) {
        return this.replace(/{{(\w*)}}/g, function(match, key, position) {
            return data[key.trim()];
        });
    };
})();
```

Минифицируем.
```javascript
/*! Tmpl.js v0.1.0 | GC92 | MIT | https://github.com/GC92/tmpl */
!function(){String.prototype.tmpl=function(t){return this.replace(/{{(\w*)}}/g,function(n,r){return t[r.trim()]})}}();
```

После минификации без учёта баннера у нас выходит всего 118 символов, что очень даже мало для такой,
казалось бы, непростой задачи. А чень меньше, тем лучше.

Подключив скрипт, использовать можно с помощью метода `.tmpl(array)`.
```javascript
var myTmpl = 'На улице {{weather}} погода - самое време пойти на {{place}} и выпить немного {{drink}}.',
    data = {
        weather: 'хорошая',
        place: 'пляж',
        drink: 'апельсинового сока'
    };

myTmpl.tmpl(data);

// Вернёт "На улице хорошая погода - самое време пойти на пляж и выпить немного апельсинового сока."
```


## Заключение

У нас получилась библиотека, которая позволяет заменять данные в строке очень удобно, ипользуя объект,
который можно задавать самому или получать из `json` файлов.

В добавок к этому:
* Простая шаблонизация в строках.
* Независит от jQuery.
* Совместимость с IE9+ (для поддержки IE8 используйте совместимую версию).
* Нановесный помошник. Нано, потому что реально очень мало весит, а делает много :)

[Tmpl](https://github.com/GC92/tmpl) - ссылка на репозиторий в GitHub.

[Скачать минифицированную версию](https://raw.githubusercontent.com/GC92/tmpl/master/tmpl.min.js).<br>
[Скачать минифицированную версию с поддержкой IE8](https://raw.githubusercontent.com/GC92/tmpl/master/tmpl.compatible.min.js).


Мораль сей басни такова: не наступайте на грабли, часто повторяющиеся велосипеды и спагетти код
превращайте в простой, повторно использующийся и легко поддерживаемый код, и будет вам счастье.
